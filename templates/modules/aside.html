<!-- 右侧边栏背景遮罩（移动端） -->
<div
  th:fragment="aside-bgmask"
  id="z-aside-bgmask"
  class="hidden"
  onclick="document.getElementById('z-aside').classList.remove('show'); this.classList.add('hidden')"
></div>

<aside th:fragment="aside" id="z-aside">
  <!-- 根据配置动态渲染小组件 -->
  <th:block th:each="item : ${theme.config.aside.widgets.index}">
    
    <!-- 博客统计 -->
    <th:block th:if="${item.widget == 'stats'}" th:insert="~{modules/aside :: widget-stats}" />
    
    <!-- 技术信息 -->
    <th:block th:if="${item.widget == 'tech-info'}" th:insert="~{modules/aside :: widget-tech-info}" />
    
    <!-- 社区群组 -->
    <th:block th:if="${item.widget == 'community'}" th:insert="~{modules/aside :: widget-community}" />
    
    <!-- 自定义组件 -->
    <section class="widget" th:if="${item.widget == 'custom' and not #strings.isEmpty(item.title)}">
      <hgroup class="widget-title text-creative" th:text="${item.title}">自定义</hgroup>
      <div class="widget-body widget-card" th:utext="${item.content}"></div>
    </section>
    
  </th:block>
</aside>

<!-- ==================== -->
<!-- 小组件片段定义 -->
<!-- ==================== -->

<!-- 博客统计 -->
<th:block th:fragment="widget-stats">
  <section class="widget">
    <hgroup class="widget-title text-creative">博客统计</hgroup>
    <div class="widget-body widget-card">
      <dl class="dl-group small">
        <div>
          <dt>运营时长</dt>
          <dd id="site-runtime" th:title="'博客于' + ${theme.config.aside.basic.site_start_time} + '上线'">-</dd>
        </div>
        <th:block th:with="latestPosts = ${postFinder.list(1, 1)}">
          <div th:if="${not #lists.isEmpty(latestPosts.items)}">
            <dt>上次更新</dt>
            <dd class="time-ago" th:data-time="${latestPosts.items[0].spec.publishTime}">-</dd>
          </div>
        </th:block>
        <div>
          <dt>文章数目</dt>
          <dd th:text="${postFinder.archives(1, 1).total}">0</dd>
        </div>
      </dl>
    </div>
  </section>
</th:block>

<!-- 技术信息 -->
<th:block th:fragment="widget-tech-info">
  <section class="widget">
    <hgroup class="widget-title text-creative">技术信息</hgroup>
    <div class="widget-body widget-card">
      <dl class="dl-group medium">
        <div>
          <dt>构建平台</dt>
          <dd class="platform-halo"><img th:src="@{/assets/images/logo.png}" alt="Halo" /> Halo</dd>
        </div>
        <div>
          <dt>图片存储</dt>
          <dd th:text="${theme.config.aside.basic.image_hosting}">本地存储</dd>
        </div>
        <div>
          <dt>软件协议</dt>
          <dd>GPL-3.0</dd>
        </div>
        <div>
          <dt>文章许可</dt>
          <dd th:text="${theme.config.aside.basic.license}">CC BY-NC-SA 4.0</dd>
        </div>
        <div>
          <dt>规范域名</dt>
          <dd class="domain-text" th:text="${site.url}"></dd>
        </div>
      </dl>

      <!-- 可展开的构建信息 -->
      <div class="z-expand" x-data="{ expand: false }">
        <div class="expand-content" x-show="expand" x-collapse>
          <dl class="dl-group small build-info">
            <div>
              <dt>Theme</dt>
              <dd>Clarity</dd>
            </div>
            <div>
              <dt>Version</dt>
              <dd th:text="${theme.spec.version}">1.0.0</dd>
            </div>
            <div>
              <dt>Framework</dt>
              <dd>Halo 2.x</dd>
            </div>
          </dl>
        </div>
        <button class="toggle-btn in-place" @click="expand = !expand">
          <span class="icon-[ph--caret-double-down-bold] toggle-icon" :class="{ 'expand': expand }"></span>
          <span x-text="expand ? '收起构建信息' : '展开构建信息'"></span>
        </button>
      </div>
    </div>
  </section>
</th:block>

<!-- 社区群组 -->
<th:block th:fragment="widget-community">
  <section class="widget dim" th:if="${not #strings.isEmpty(theme.config.aside.community.image)}">
    <hgroup class="widget-title text-creative" th:text="${theme.config.aside.community.title}">
      博客/技术社区
    </hgroup>
    <div class="widget-body widget-card with-bg">
      <img class="bg-img bg-right" th:src="${theme.config.aside.community.image}" alt="" loading="lazy" />
      <div class="comm-title text-creative" th:text="${theme.config.aside.community.name}">技术交流群</div>
      <p class="comm-tip">
        <span class="icon-[ph--chat-circle-dots-bold]"></span>
        <span th:text="${theme.config.aside.community.desc}">169994096</span>
      </p>
    </div>
  </section>
</th:block>

<!-- ==================== -->
<!-- 右侧栏脚本 -->
<!-- ==================== -->
<th:block th:fragment="aside-scripts">
  <script th:inline="javascript">
    (function () {
      // 计算运营时长
      const startTime = /*[[${theme.config.aside.basic.site_start_time}]]*/ "";
      if (startTime) {
        const start = new Date(startTime).getTime();
        const now = Date.now();
        const days = Math.floor((now - start) / (1000 * 60 * 60 * 24));

        const years = Math.floor(days / 365);
        const remainingDays = days % 365;
        const months = Math.floor(remainingDays / 30);

        let text = "";
        if (years > 0) text += years + "年";
        if (months > 0) text += months + "个月";
        if (years === 0 && months === 0) text = days + "天";

        const el = document.getElementById("site-runtime");
        if (el) el.textContent = text;
      }

      // 计算相对时间
      document.querySelectorAll(".time-ago").forEach((el) => {
        const timeStr = el.getAttribute("data-time");
        if (timeStr) {
          const time = new Date(timeStr).getTime();
          const now = Date.now();
          const diff = now - time;
          const minutes = Math.floor(diff / (1000 * 60));
          const hours = Math.floor(diff / (1000 * 60 * 60));
          const days = Math.floor(diff / (1000 * 60 * 60 * 24));

          let text = "";
          if (days > 0) text = days + "天前";
          else if (hours > 0) text = hours + "小时前";
          else if (minutes > 0) text = minutes + "分钟前";
          else text = "刚刚";

          el.textContent = text;
          el.title = "更新于 " + new Date(timeStr).toLocaleString("zh-CN");
        }
      });
    })();
  </script>
</th:block>
